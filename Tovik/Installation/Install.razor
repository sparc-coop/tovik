@using Tovik.Domains
<section class="welcome">
    <header>
        @if (SparcDomain != null)
        {
            <img src="@SparcDomain.FaviconUri" alt="@SparcDomain.Domain" onerror="this.src='/images/Star.svg'" />
        }
        <h3 style="margin-top: 20px">Activate Tovik on @Domain</h3>
    </header>

    @if (SelectedPlatform == null)
    {
        <p>
            Welcome to Tovik! We're so happy you're here.
        </p>
        <p>
            Tovik is a website plugin that makes it easy to translate your website into multiple languages, so you can reach a global audience without the hassle of managing translations manually.
        </p>
        <p>To get started, select your website's platform:</p>
    }
    else
    {
    }

    <ul class="platforms">
        @foreach (var platform in Platforms)
        {
            <li class="@(SelectedPlatform == platform ? "selected" : "")">
                <button class="primary-btn" @onclick="@(() => Select(platform))">
                    @platform
                </button>
            </li>
        }
    </ul>

    @if (SelectedPlatform == "HTML")
    {
        <div>
            <ol>
                <li>
                    Add this line of code to your site (preferably just before the closing <code translate="no">&lt;&sol;body&gt;</code> tag):<br /><br />
                    <CodeBlock CanCopy=true>
                        @("<script type=\"module\" src=\"https://tovik.app/tovik.js\"></script>")
                    </CodeBlock>
                </li>
            </ol>
        </div>
    }

    @if (SelectedPlatform == "WordPress")
    {
        <div>
            <ol>
                <li>
                    Download the official Tovik WordPress plugin here:<br />
                    <a href="/plugins/wordpress/tovik.zip" class="button secondary-btn">Download Tovik for WordPress</a>
                </li>
                <li>Go to your WordPress admin dashboard and navigate to <strong>Plugins</strong> &gt; <strong>Add New</strong>.</li>
                <li>Click <strong>Upload Plugin</strong> and select the downloaded <code translate="no">tovik.zip</code> file.</li>
                <li>Click <strong>Install Now</strong>.</li>
                <li>Once installed, click <strong>Activate Plugin</strong>.</li>
            </ol>
        </div>
    }

    @if (SelectedPlatform == "Wix")
    {
        <div>
            <ol>
                <li>
                    Open the Tovik install link:<br />
                    <a href="https://wix.to/AmoRmd7" class="button secondary-btn" target="_blank" rel="noopener">Install Tovik for Wix</a>
                </li>
                <li>Click <strong>Add to Site</strong>.</li>
                <li>Choose the Wix site you want to install Tovik on and click <strong>Continue</strong>.</li>
                <li>Review the requested permissions, then click <strong>Accept &amp; Add</strong>.</li>
                <li>You’ll be redirected to your Wix dashboard → the Tovik app panel will open.</li>
                <li>Click <strong>Activate Tovik</strong>.</li>
                <li>Publish your site to apply the changes.</li>
            </ol>
        </div>
    }

    @if (SelectedPlatform == "SquareSpace")
    {
        <div>
            <ol>
                <li>Log in to your Squarespace account.</li>
                <li>Open the site on which you want to enable Tovik.</li>
                <li>Click <strong>Edit Site</strong> to open the site editor.</li>
                <li>
                    In the left-hand menu, look for the <strong>Code Injection</strong> panel. Depending on your Squarespace version, it may appear under:
                    <ul>
                        <li><strong>Pages → Custom Code → Code Injection</strong>, OR</li>
                        <li><strong>Settings → Advanced (or Website Tools) → Code Injection</strong>.</li>
                    </ul>
                </li>
                <li>Paste the following snippet into the section labeled <strong>Footer</strong>:</li>
                <CodeBlock CanCopy=true>
                    @("<script type=\"module\" src=\"https://tovik.app/tovik.js\"></script>")
                </CodeBlock>
                <li>Click <strong>Save</strong>.</li>
            </ol>

            <h3>Notes</h3>
            <ul>
                <li>The menu location may vary, but the option is always called <strong>Code Injection</strong>.</li>
                <li>Add the code to the section labeled <strong>Footer</strong> so the script loads at the end of the <code translate="no">&lt;&sol;body&gt;</code>.</li>
                <li>In Squarespace’s site editor, scripts may not run. Always test on your published site in an incognito/private window.</li>
                <li>Checkout pages generally do not support injected scripts.</li>
            </ul>
        </div>
    }

    @if (SelectedPlatform == "Webflow")
    {
        <div>
            <ol>
                <li>Log in to your Webflow account.</li>
                <li>Click the button labeled <strong>Site Settings</strong> on the site in which you want to enable Tovik.</li>
                <li>In the left-hand menu, click <strong>Custom Code</strong>:</li>
                <li>Paste the following snippet into the section labeled <strong>Footer code</strong>:</li>
                <CodeBlock CanCopy=true>
                    @("<script type=\"module\" src=\"https://tovik.app/tovik.js\"></script>")
                </CodeBlock>
                <li>Click <strong>Save changes</strong>.</li>
            </ol>

            <h3>Notes</h3>
            <ul>
                <li>Add the code to the section labeled <strong>Footer code</strong> so the script loads at the end of the <code translate="no">&lt;&sol;body&gt;</code>.</li>
                <li>The effects of custom code appear in preview mode, but they won’t go live until your site is published. </li>
            </ul>
        </div>
    }

    @if (SelectedPlatform == "Weebly")
    {
        <div>
            <ol>
                <li>Log in to your Weebly account.</li>
                <li>Click <strong>Edit Site</strong> to open the site editor.</li>
                <li>In the top menu, click <strong>Settings</strong>.</li>
                <li>In the left-hand menu, click <strong>SEO</strong>.</li>
                <li>Paste the following snippet into the section labeled <strong>Footer Code</strong>:</li>
                <CodeBlock CanCopy=true>
                    @("<script type=\"module\" src=\"https://tovik.app/tovik.js\"></script>")
                </CodeBlock>
                <li>Click <strong>Save</strong>.</li>
            </ol>

            <h3>Notes</h3>
            <ul>
                <li>Add the code to the section labeled <strong>Footer Code</strong> so the script loads at the end of the <code translate="no">&lt;&sol;body&gt;</code>.</li>
                <li>In Weebly’s site editor, scripts may not run. Always test on your published site.</li>
            </ul>
        </div>
    }

    @if (SelectedPlatform == "Shopify")
    {
        <div>
            <ol>
                <li>Log in to your Shopify account.</li>
                <li>Open the site on which you want to enable Tovik.</li>
                <li>Click the <strong>three-dots button</strong> for more actions.</li>
                <li>Select <strong>Edit code</strong>.</li>
                <li>You’ll be redirected to the code editor.</li>
                <li>In the left-hand menu, expand <strong>layout</strong>.</li>
                <li>Click <strong>theme.liquid</strong>.</li>
                <li>Paste the following snippet immediately above the <strong><code translate="no">&lt;&sol;body&gt;</code></strong> tag (on the line directly before it):</li>
                <CodeBlock CanCopy=true>
                    @("<script type=\"module\" src=\"https://tovik.app/tovik.js\"></script>")
                </CodeBlock>
                <li>Click <strong>Save</strong>.</li>
            </ol>
        </div>
    }

    @if (SelectedPlatform != null)
    {
        <footer>
            <button class="primary-btn" @onclick="Activate">Activate Tovik</button>
            @if (Error != null)
            {
                <p class="error-message">@Error</p>
            }
        </footer>
    }
</section>

@inject TovikDomains Domains
@code {
    [Parameter][SupplyParameterFromQuery] public required string Domain { get; set; }
    [Parameter][SupplyParameterFromQuery] public string? TierId { get; set; }
    SparcDomain? SparcDomain { get; set; }
    List<string> Platforms = ["WordPress", "Wix", "SquareSpace", "Webflow", "Weebly", "Shopify", "HTML"];
    List<string> ComingSoon = [];
    string? SelectedPlatform { get; set; } = null;
    string? Error;

    protected override async Task OnInitializedAsync()
    {
        SparcDomain = await Domains.Verify(Domain);
    }

    private void Select(string platform)
    {
        if (SelectedPlatform == platform)
        {
            SelectedPlatform = null;
        }
        else
        {
            SelectedPlatform = platform;
        }
    }

    async Task Activate()
    {
        if (SparcDomain == null)
            return;

        Error = null;
        try
        {
            var result = await SparcDomain.VerifyAsync();
            if (result)
            {
                await Domains.Update(SparcDomain);
                Nav.NavigateTo("/sites/" + SparcDomain.Id);
            }
            else
            {
                Error = $"Tovik does not yet appear to be installed on {SparcDomain.Domain}. Please double-check the install instructions and try again!";
            }
        }
        catch (Exception e)
        {
            Error = e.Message + " " + e.InnerException?.Message + " Please double-check the install instructions and try again!";
        }
    }

    void ChangeTab(string tab)
    {
        if (tab == "Install")
            Nav.NavigateTo("/Install?domain=" + Domain, true);
        else if (tab == "Purchase")
            Nav.NavigateTo("/Purchase/" + TierId + "?domain=" + Domain, true);
    }

}
