@using Sparc.Blossom.Content
@using Tovik.Domains

<section class="domain-summary">
	<header>
		<h3>Pages Translated</h3>
		<UsageMeter Domain="Domain" />
	</header>
	<div>
		@foreach (var webpage in Pages)
		{
			<div class="page">
				<header translate="no">
					@webpage.Path
				</header>
				<ul>
					@foreach (var languageId in webpage.TovikUsage.Keys.OrderByDescending(x => webpage.TovikUsage[x]))
					{
						var language = Language.Find(languageId);
						if (language != null)
						{
							<li title="@language.NativeName (@language.DisplayName)">
								<a href="@webpage.AbsolutePath(languageId)" target="_blank">
									<span class="language-id">@language.NativeName</span>
									<span class="count">@Pretty(webpage.TovikUsage[languageId])</span>
								</a>
							</li>
						}
					}
				</ul>
			</div>
		}

		@if (!Pages.Any())
		{
			<aside>Nothing to see here yet!</aside>
		}
	</div>
</section>

@inject TovikDomains Domains
@code {
	[Parameter] public required SparcDomain Domain { get; set; }
	List<Page> Pages = [];

	protected override async Task OnParametersSetAsync()
	{
		Pages = await Domains.GetPages(Domain.Domain);
	}

	private string Pretty(int count)
	{
		if (count >= 1_000_000_000)
			return (count / 1_000_000_000D).ToString("0.#") + "B";
		if (count >= 1_000_000)
			return (count / 1_000_000D).ToString("0.#") + "M";
		if (count >= 1_000)
			return (count / 1_000D).ToString("0.#") + "K";
		return count.ToString();
	}
}
